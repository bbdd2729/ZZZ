# Unityé¡¹ç›®æºç æ”¹è¿›å»ºè®®

## é¡¹ç›®æ¦‚è¿°
è¿™æ˜¯ä¸€ä¸ªåŸºäºUnityçš„3DåŠ¨ä½œæ¸¸æˆé¡¹ç›®ï¼Œä½¿ç”¨äº†URPæ¸²æŸ“ç®¡çº¿ï¼Œå®ç°äº†è§’è‰²çŠ¶æ€æœºã€äº‹ä»¶ç³»ç»Ÿã€è¾“å…¥ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚é¡¹ç›®ç»“æ„ç›¸å¯¹å®Œæ•´ï¼Œä½†åœ¨ä»£ç è´¨é‡ã€æ€§èƒ½ä¼˜åŒ–ã€æ¶æ„è®¾è®¡ç­‰æ–¹é¢è¿˜æœ‰å¾ˆå¤§æå‡ç©ºé—´ã€‚

## ğŸ¯ ä¸»è¦æ”¹è¿›å»ºè®®

### 1. ä»£ç ç»“æ„å’Œæ¶æ„æ”¹è¿›

#### 1.1 ä¾èµ–æ³¨å…¥ç³»ç»Ÿå®Œå–„
**ç°çŠ¶é—®é¢˜ï¼š**
- VContaineré…ç½®ä¸å®Œæ•´ï¼Œç¼ºå°‘ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å­˜åœ¨ç›´æ¥å¼•ç”¨å…·ä½“å®ç°çš„æƒ…å†µï¼Œè¿åä¾èµ–å€’ç½®åŸåˆ™
- ç¼ºå°‘æ¥å£æŠ½è±¡ï¼Œè€¦åˆåº¦é«˜

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// åˆ›å»ºæ¥å£æŠ½è±¡
public interface IPlayerManager
{
    void AddPlayer(IPlayerController controller);
    void SwitchNextPlayer();
    IPlayerController CurrentPlayer { get; }
}

// å®Œå–„DIé…ç½®
public class GameLifetimeScope : LifetimeScope
{
    protected override void Configure(IContainerBuilder builder)
    {
        // æ³¨å†Œä¸ºæ¥å£ï¼Œé™ä½è€¦åˆ
        builder.Register<IPlayerManager, PlayerManager>(Lifetime.Singleton);
        builder.Register<IInputManager, InputManager>(Lifetime.Singleton);
        builder.Register<IEventBus, EventBus>(Lifetime.Singleton);
        
        // é…ç½®è®¾ç½®
        builder.RegisterInstance<GameConfig>(config);
        
        // æ³¨å†Œå…¥å£ç‚¹
        builder.RegisterEntryPoint<GameBootstrap>();
    }
}
```

#### 1.2 æ¶æ„åˆ†å±‚ä¼˜åŒ–
**ç°çŠ¶é—®é¢˜ï¼š**
- MVCåˆ†å±‚ä¸æ¸…æ™°ï¼ŒèŒè´£æ··ä¹±
- ä¸šåŠ¡é€»è¾‘ä¸Unityç”Ÿå‘½å‘¨æœŸè€¦åˆè¿‡æ·±
- ç¼ºå°‘é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰æŠ½è±¡

**æ”¹è¿›å»ºè®®ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Presentation Layer        â”‚
â”‚  (Unity MonoBehaviour, UI, Input)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Application Layer           â”‚
â”‚   (Use Cases, Application Services)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          Domain Layer               â”‚
â”‚    (Business Logic, Entities)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Infrastructure Layer         â”‚
â”‚  (Data Access, External Services)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ€§èƒ½ä¼˜åŒ–

#### 2.1 å†…å­˜åˆ†é…ä¼˜åŒ–
**ç°çŠ¶é—®é¢˜ï¼š**
- é¢‘ç¹GCåˆ†é…ï¼Œå¦‚æ¯å¸§åˆ›å»ºæ–°å¯¹è±¡
- æœªä½¿ç”¨å¯¹è±¡æ± ç®¡ç†é¢‘ç¹åˆ›å»ºçš„å¯¹è±¡
- å­—ç¬¦ä¸²æ‹¼æ¥æœªä¼˜åŒ–

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// ä½¿ç”¨StringBuilderä¼˜åŒ–å­—ç¬¦ä¸²æ“ä½œ
public class PerformanceOptimizedLogger
{
    private readonly StringBuilder _stringBuilder = new StringBuilder(256);
    
    public void LogPlayerState(IPlayerController player)
    {
        _stringBuilder.Clear();
        _stringBuilder.Append("Player: ");
        _stringBuilder.Append(player.Name);
        _stringBuilder.Append(" Health: ");
        _stringBuilder.Append(player.Health);
        
        Debug.Log(_stringBuilder.ToString());
    }
}

// å®ç°å¯¹è±¡æ± 
public class StateMachinePool
{
    private readonly Stack<StateMachine> _pool = new Stack<StateMachine>();
    
    public StateMachine Get()
    {
        return _pool.Count > 0 ? _pool.Pop() : new StateMachine();
    }
    
    public void Return(StateMachine stateMachine)
    {
        stateMachine.Reset();
        _pool.Push(stateMachine);
    }
}
```

#### 2.2 CPUæ€§èƒ½ä¼˜åŒ–
**ç°çŠ¶é—®é¢˜ï¼š**
- æ¯å¸§è¿›è¡Œä¸å¿…è¦çš„è®¡ç®—
- æœªä½¿ç”¨ç¼“å­˜æœºåˆ¶
- åŠ¨ç”»çŠ¶æ€æ£€æŸ¥è¿‡äºé¢‘ç¹

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
public class OptimizedStateMachine
{
    private float _lastAnimationCheckTime;
    private const float ANIMATION_CHECK_INTERVAL = 0.1f; // 100msæ£€æŸ¥ä¸€æ¬¡
    
    public void Update()
    {
        var currentTime = Time.time;
        
        // å‡å°‘åŠ¨ç”»çŠ¶æ€æ£€æŸ¥é¢‘ç‡
        if (currentTime - _lastAnimationCheckTime >= ANIMATION_CHECK_INTERVAL)
        {
            CheckAnimationState();
            _lastAnimationCheckTime = currentTime;
        }
        
        // å…¶ä»–æ›´æ–°é€»è¾‘...
    }
    
    // ç¼“å­˜åŠ¨ç”»å“ˆå¸Œå€¼ï¼Œé¿å…å­—ç¬¦ä¸²æ¯”è¾ƒ
    private readonly int _attackAnimationHash = Animator.StringToHash("Attack");
}
```

### 3. çŠ¶æ€æœºç³»ç»Ÿæ”¹è¿›

#### 3.1 çŠ¶æ€æœºé‡æ„
**ç°çŠ¶é—®é¢˜ï¼š**
- çŠ¶æ€åˆ‡æ¢é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥ç»´æŠ¤
- ç¼ºå°‘çŠ¶æ€è½¬æ¢æ¡ä»¶éªŒè¯
- çŠ¶æ€é—´è€¦åˆåº¦è¿‡é«˜

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// å®ç°çŠ¶æ€è½¬æ¢è§„åˆ™
public class StateTransitionRules
{
    private readonly Dictionary<Type, List<Type>> _allowedTransitions = new();
    
    public void AddTransition<TFrom, TTo>() where TFrom : IState where TTo : IState
    {
        var fromType = typeof(TFrom);
        if (!_allowedTransitions.ContainsKey(fromType))
            _allowedTransitions[fromType] = new List<Type>();
            
        _allowedTransitions[fromType].Add(typeof(TTo));
    }
    
    public bool CanTransition(IState currentState, IState targetState)
    {
        var currentType = currentState.GetType();
        var targetType = targetState.GetType();
        
        return _allowedTransitions.ContainsKey(currentType) && 
               _allowedTransitions[currentType].Contains(targetType);
    }
}

// æ”¹è¿›çš„çŠ¶æ€æœº
public class ImprovedStateMachine
{
    private readonly StateTransitionRules _transitionRules;
    
    public void ChangeState<T>() where T : IState
    {
        var targetState = GetState<T>();
        var currentState = _currentState;
        
        // éªŒè¯çŠ¶æ€è½¬æ¢
        if (!_transitionRules.CanTransition(currentState, targetState))
        {
            Debug.LogWarning($"Invalid state transition: {currentState?.GetType().Name} -> {typeof(T).Name}");
            return;
        }
        
        // æ‰§è¡ŒçŠ¶æ€è½¬æ¢
        currentState?.OnExit();
        _currentState = targetState;
        _currentState.OnEnter();
    }
}
```

### 4. äº‹ä»¶ç³»ç»Ÿä¼˜åŒ–

#### 4.1 äº‹ä»¶ç³»ç»Ÿé‡æ„
**ç°çŠ¶é—®é¢˜ï¼š**
- äº‹ä»¶ç±»å‹ç¡¬ç¼–ç ï¼Œæ‰©å±•æ€§å·®
- ç¼ºå°‘äº‹ä»¶ä¼˜å…ˆçº§å’Œå–æ¶ˆæœºåˆ¶
- äº‹ä»¶è®¢é˜…ç®¡ç†ä¸å®Œå–„

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// å®ç°å¯å–æ¶ˆäº‹ä»¶
public interface ICancellableEvent
{
    bool IsCancelled { get; set; }
}

// äº‹ä»¶ä¼˜å…ˆçº§
public enum EventPriority
{
    Low = 0,
    Normal = 1,
    High = 2,
    Critical = 3
}

// æ”¹è¿›çš„äº‹ä»¶ç³»ç»Ÿ
public class AdvancedEventBus
{
    private readonly Dictionary<Type, List<EventSubscription>> _subscriptions = new();
    
    public IDisposable Subscribe<T>(Action<T> handler, EventPriority priority = EventPriority.Normal)
    {
        var eventType = typeof(T);
        var subscription = new EventSubscription(handler, priority);
        
        if (!_subscriptions.ContainsKey(eventType))
            _subscriptions[eventType] = new List<EventSubscription>();
            
        _subscriptions[eventType].Add(subscription);
        _subscriptions[eventType].Sort((a, b) => b.Priority.CompareTo(a.Priority));
        
        return new SubscriptionDisposable(() => 
        {
            _subscriptions[eventType].Remove(subscription);
        });
    }
}
```

### 5. é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿæ”¹è¿›

#### 5.1 å®Œå–„çš„é”™è¯¯å¤„ç†
**ç°çŠ¶é—®é¢˜ï¼š**
- ç¼ºå°‘å¼‚å¸¸å¤„ç†æœºåˆ¶
- æ—¥å¿—ç³»ç»Ÿè¿‡äºç®€å•
- æ²¡æœ‰é”™è¯¯æ¢å¤æœºåˆ¶

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// å®ç°ç»“æ„åŒ–æ—¥å¿—
public interface ILogger
{
    void LogInformation(string message, object data = null);
    void LogWarning(string message, object data = null);
    void LogError(string message, Exception exception = null, object data = null);
    void LogDebug(string message, object data = null);
}

// é”™è¯¯æ¢å¤æœºåˆ¶
public class ErrorRecoverySystem
{
    private readonly Dictionary<Type, Func<Exception, bool>> _recoveryStrategies = new();
    
    public void RegisterRecoveryStrategy<TException>(Func<TException, bool> strategy) 
        where TException : Exception
    {
        _recoveryStrategies[typeof(TException)] = ex => strategy((TException)ex);
    }
    
    public bool TryRecover(Exception exception)
    {
        var exceptionType = exception.GetType();
        
        if (_recoveryStrategies.TryGetValue(exceptionType, out var strategy))
        {
            return strategy(exception);
        }
        
        return false;
    }
}
```

### 6. è¾“å…¥ç³»ç»Ÿä¼˜åŒ–

#### 6.1 è¾“å…¥ç¼“å†²å’Œé¢„æµ‹
**ç°çŠ¶é—®é¢˜ï¼š**
- è¾“å…¥å“åº”å»¶è¿Ÿ
- ç¼ºå°‘è¾“å…¥ç¼“å†²æœºåˆ¶
- ç½‘ç»œç¯å¢ƒä¸‹è¾“å…¥ä¸åŒæ­¥

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
public class InputBuffer
{
    private readonly Queue<InputAction> _buffer = new Queue<InputAction>();
    private readonly int _maxBufferSize = 5;
    private readonly float _bufferTime = 0.2f;
    
    public void AddInput(InputAction action)
    {
        if (_buffer.Count >= _maxBufferSize)
            _buffer.Dequeue();
            
        _buffer.Enqueue(action);
    }
    
    public InputAction GetBufferedInput()
    {
        if (_buffer.Count > 0)
        {
            var input = _buffer.Peek();
            if (Time.time - input.startTime <= _bufferTime)
            {
                _buffer.Dequeue();
                return input;
            }
        }
        
        return null;
    }
}
```

### 7. ä»£ç è§„èŒƒå’Œå‘½åæ”¹è¿›

#### 7.1 å‘½åè§„èŒƒç»Ÿä¸€
**ç°çŠ¶é—®é¢˜ï¼š**
- å‘½åé£æ ¼ä¸ç»Ÿä¸€ï¼ˆcamelCaseä¸PascalCaseæ··ç”¨ï¼‰
- ç¼ºå°‘å‘½åç©ºé—´ç»„ç»‡
- æ–‡ä»¶å‘½åä¸è§„èŒƒ

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// ç»Ÿä¸€çš„å‘½åè§„èŒƒ
namespace GameName.Core.Player
{
    // æ¥å£ä½¿ç”¨Iå‰ç¼€
    public interface IPlayerController
    {
        // å±æ€§ä½¿ç”¨PascalCase
        string PlayerName { get; }
        
        // æ–¹æ³•ä½¿ç”¨PascalCase
        void TakeDamage(float damage);
        
        // äº‹ä»¶ä½¿ç”¨PascalCase + Eventåç¼€
        event Action<PlayerDiedEvent> PlayerDiedEvent;
    }
    
    // ç±»ä½¿ç”¨PascalCase
    public class PlayerController : MonoBehaviour, IPlayerController
    {
        // ç§æœ‰å­—æ®µä½¿ç”¨_camelCaseå‰ç¼€
        private readonly float _maxHealth;
        
        // å¸¸é‡ä½¿ç”¨UPPER_CASE
        private const float DEFAULT_HEALTH = 100f;
        
        // å…¬å¼€å±æ€§ä½¿ç”¨PascalCase
        public string PlayerName { get; private set; }
    }
}
```

### 8. æµ‹è¯•å’Œå¯ç»´æŠ¤æ€§æ”¹è¿›

#### 8.1 å•å…ƒæµ‹è¯•æ”¯æŒ
**ç°çŠ¶é—®é¢˜ï¼š**
- ä»£ç éš¾ä»¥å•å…ƒæµ‹è¯•
- ç¼ºå°‘ä¾èµ–æ³¨å…¥
- å¼ºè€¦åˆUnityå¼•æ“

**æ”¹è¿›å»ºè®®ï¼š**
```csharp
// å¯æµ‹è¯•çš„æ¶æ„
public interface ITimeService
{
    float DeltaTime { get; }
    float Time { get; }
}

public class UnityTimeService : ITimeService
{
    public float DeltaTime => Time.deltaTime;
    public float Time => UnityEngine.Time.time;
}

public class TestTimeService : ITimeService
{
    public float DeltaTime { get; set; }
    public float Time { get; set; }
}

// å¯æµ‹è¯•çš„çŠ¶æ€æœº
public class TestableStateMachine
{
    private readonly ITimeService _timeService;
    
    public TestableStateMachine(ITimeService timeService)
    {
        _timeService = timeService;
    }
    
    public void Update()
    {
        // ä½¿ç”¨æ³¨å…¥çš„æ—¶é—´æœåŠ¡ï¼Œä¾¿äºæµ‹è¯•
        var deltaTime = _timeService.DeltaTime;
        // æ›´æ–°é€»è¾‘...
    }
}
```

## ğŸ“Š æ€§èƒ½ç›‘æ§å’Œåˆ†æ

### å®ç°æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
```csharp
public class PerformanceMonitor
{
    private readonly Dictionary<string, PerformanceMetric> _metrics = new();
    
    public void StartMeasurement(string metricName)
    {
        _metrics[metricName] = new PerformanceMetric
        {
            StartTime = Time.realtimeSinceStartup,
            StartMemory = GC.GetTotalMemory(false)
        };
    }
    
    public void EndMeasurement(string metricName)
    {
        if (_metrics.TryGetValue(metricName, out var metric))
        {
            var elapsedTime = Time.realtimeSinceStartup - metric.StartTime;
            var memoryDelta = GC.GetTotalMemory(false) - metric.StartMemory;
            
            Debug.Log($"[{metricName}] Time: {elapsedTime:F3}ms, Memory: {memoryDelta / 1024:F2}KB");
        }
    }
}
```

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰
1. **ä¾èµ–æ³¨å…¥ç³»ç»Ÿå®Œå–„** - è§£å†³æ¶æ„åŸºç¡€é—®é¢˜
2. **æ€§èƒ½ä¼˜åŒ–** - å†…å­˜åˆ†é…å’ŒCPUæ€§èƒ½
3. **é”™è¯¯å¤„ç†æœºåˆ¶** - æé«˜ä»£ç ç¨³å®šæ€§

### ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå®æ–½ï¼‰
1. **çŠ¶æ€æœºç³»ç»Ÿé‡æ„** - æé«˜ä»£ç å¯ç»´æŠ¤æ€§
2. **äº‹ä»¶ç³»ç»Ÿä¼˜åŒ–** - å¢å¼ºæ‰©å±•æ€§
3. **ä»£ç è§„èŒƒç»Ÿä¸€** - æé«˜ä»£ç è´¨é‡

### ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè§„åˆ’ï¼‰
1. **æµ‹è¯•æ¡†æ¶æ­å»º** - æé«˜ä»£ç å¯é æ€§
2. **æ–‡æ¡£å®Œå–„** - æé«˜å›¢é˜Ÿåä½œæ•ˆç‡
3. **æ€§èƒ½ç›‘æ§ç³»ç»Ÿ** - æŒç»­æ€§èƒ½ä¼˜åŒ–

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡
- å†…å­˜åˆ†é…å‡å°‘50%ä»¥ä¸Š
- CPUä½¿ç”¨ç‡é™ä½30%
- å¸§ç‡ç¨³å®šæ€§æå‡

### ä»£ç è´¨é‡æå‡
- ä»£ç é‡å¤ç‡é™ä½
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡æå‡åˆ°80%+
- Bugç‡é™ä½60%

### å¼€å‘æ•ˆç‡æå‡
- æ–°åŠŸèƒ½å¼€å‘æ—¶é—´ç¼©çŸ­40%
- ä»£ç ç»´æŠ¤æˆæœ¬é™ä½50%
- å›¢é˜Ÿåä½œæ•ˆç‡æå‡

## ğŸš€ æ€»ç»“

è¿™ä¸ªé¡¹ç›®å…·æœ‰è‰¯å¥½çš„åŸºç¡€æ¶æ„ï¼Œä½†éœ€è¦åœ¨å¤šä¸ªæ–¹é¢è¿›è¡Œä¼˜åŒ–å’Œæ”¹è¿›ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„é‡æ„å’Œä¼˜åŒ–ï¼Œå¯ä»¥æ˜¾è‘—æå‡é¡¹ç›®çš„æ€§èƒ½ã€å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½è¿™äº›æ”¹è¿›å»ºè®®ï¼Œç¡®ä¿é¡¹ç›®çš„ç¨³å®šæ€§å’ŒæŒç»­å‘å±•ã€‚