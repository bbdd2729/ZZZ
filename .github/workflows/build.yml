name: Game Build Action

# æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒé€‰æ‹©åˆ†æ”¯ + è¾“å…¥ç‰ˆæœ¬å·
on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯æˆ–æ ‡ç­¾'
        required: true
        default: 'main'
        type: string
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¼šæ‹¼åˆ°æ–‡ä»¶åé‡Œï¼‰'
        required: true
        type: string
      unityVersion: 
        description: 'Unity ç‰ˆæœ¬å·ï¼ˆé»˜è®¤ 6000.0.60f1ï¼‰'
        required: false
        type: string
        default: '6000.0.60f1'   # ğŸ‘ˆ é»˜è®¤å€¼

jobs:
  build:
    name: Build ${{ matrix.targetPlatform }} âœ¨
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false          # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å¦ä¸€ä¸ª
      matrix:
        targetPlatform:
          - StandaloneWindows64 # Windows 64 ä½ (.exe)
          - Android             # Android (.apk)
    steps:
      # 1. æ‹‰å–ç”¨æˆ·æŒ‡å®šçš„åˆ†æ”¯/æ ‡ç­¾
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ inputs.ref }}

      # 2. Git LFS ç¼“å­˜ï¼šå…ˆç”Ÿæˆæ–‡ä»¶æŒ‡çº¹ï¼Œå†å‘½ä¸­ç¼“å­˜ï¼Œæœ€åæ‹‰å–å¤§æ–‡ä»¶
      - name: ç”Ÿæˆ LFS æ–‡ä»¶æŒ‡çº¹
        run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id

      - name: è¿˜åŸ LFS ç¼“å­˜
        uses: actions/cache@v3
        id: lfs-cache
        with:
          path: .git/lfs
          key: ${{ runner.os }}-lfs-${{ hashFiles('.lfs-assets-id') }}

      - name: æ‹‰å– LFS å¤§æ–‡ä»¶
        run: |
          git lfs pull
          git add .
          git reset --hard

      # 3. Library ç¼“å­˜ï¼šæŒ‰å¹³å°åˆ†åˆ«ç¼“å­˜ï¼Œé¿å…äº¤å‰æ±¡æŸ“
      - name: è¿˜åŸ Library ç¼“å­˜
        uses: actions/cache@v4.3.0
        with:
          path: Library
          key: Library-${{ matrix.targetPlatform }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.targetPlatform }}-

      # 4. Unity æ„å»º
      - name: Unity æ‰“åŒ… ${{ matrix.targetPlatform }}
        uses: game-ci/unity-builder@v4.8.1
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          unityVersion: ${{ inputs.unityVersion }}   # ğŸ‘ˆ ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥

      # 5. ä¸Šä¼ åˆ¶å“ï¼šæ–‡ä»¶åé‡Œæ‹¼å…¥ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿åŒºåˆ†
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ matrix.targetPlatform }}-v${{ inputs.version }}
          path: build
